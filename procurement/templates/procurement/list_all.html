{% extends 'procurement/base.html' %}
{% load humanize %}

{% block header %}

  <li><a href="{% url 'procurement:list_request' %}">発注依頼詳細</a></li>
  <li><a href="{% url 'procurement:list_order' %}">発注詳細</a></li>

{% endblock%}


{% block content %}


<div class="menu_wrapper">
  <div><h3>発注依頼（事業部処理）</h3></div>
  <div class="menu_wrapper_inner">
    <a class="menu_bt" href="{% url 'procurement:create_request' %}">発注依頼</a>
    <a class="menu_bt menu_bt_mg_left row-blue">検収実行</a>
  </div>
</div>

<table class="item-table">

	<tr>
		<th class="sticky_col_th first_col">選択</th>
		<th class="sticky_col_th second_col">依頼番号</th>
    <th>依頼日</th>
    <th>進捗</th>
    <th>発注番号</th>
    <th>依頼者</th>
    <th>依頼者所属</th>
    <th>希望納期</th>
		<th>納品先</th>
		<th>分類1</th>
		<th>分類2</th>
		<th>標準備品</th>
    <th>目的・発注要件</th>
		<th>数量</th>
		<th>税込総額</th>
		<th>管理担当</th>
		<th>管理メモ</th>

  </tr>
  
  {% for item in object_list %}

  <!-- 進捗状況に応じた色の設定 -->
    {% if item.adminCheck.no == 1 %}
    <tr class="row-white">
    {%  elif item.adminCheck.no == 2 %}
      <tr class="row-yellow">
    {%  elif item.adminCheck.no == 0 %}
      <tr class="row-red">
    {%  elif item.adminCheck.no == 4 %}
      <tr class="row-blue">
    {%  elif item.adminCheck.no == 5 %}
      <tr class="row-green">
    {%  elif item.adminCheck.no == 6 %}
      <tr class="row-gray">
    {% endif %}

      <td class="sticky_col_td first_col">
        <input type="checkbox" name="selected_requestNum" value="{{ item.requestNum }}">
      </td>

      <td class="sticky_col_td second_col">
        <a href="{% url 'procurement:detail_request' item.pk %}">
          {{ item.requestNum }}
        </a>
      </td>
     
      <td class="date_col">{{ item.submissionDate | date:"Y/m/d"}}</td>
      <td>{{ item.adminCheck.name }}</td>
      <td>{{ item.orderInfo.orderNum }}</td>

      <td>{{ item.requestStaff }}</td>
      <td>{{ item.requestStaffDivision }}</td>
    
      <td class="date_col">{{ item.dueDate | date:"Y/m/d"}}</td>
      <td>{{ item.deliveryAddress.name }}</td>

      <td>{{ item.itemCategory1.name }}</td>
      <td>{{ item.itemCategory2.name }}</td>
      <td>{{ item.standardItem.name }}</td>
      <td class="longText">{{ item.requestDescription }}</td>
      <td>{{ item.quantity }}</td>
      <td class="number_col">{{ item.estimatedAmount|intcomma }}</td>

      <td>
        {%  if item.adminStaff %}
          {{ item.adminStaff }}
        {%  else %}
        {% endif %}  
      </td>
      <td class="longText">
        {%  if item.adminDescription %}
          {{ item.adminDescription }}
        {%  else %}
        {% endif %} 
      </td>
          
  </tr>

  {% endfor %}
  
</table>

<div class="menu_wrapper amount_check">

  <dt>発注依頼合計</dt>
  <dd><input type="tel" id="request_amount"></dd>

  <dt>発注金額</dt>
  <dd><input type="tel" id="order_amount"></dd>

  
  <dt>差額</dt>
  <dd><input type="tel" id="diff_amount"></dd>

</div>



<form action="{% url 'procurement:update_request_order' 1 %}" method="post">
{% csrf_token %}
<div class="menu_wrapper">
  <div><h3>発注（原則として総務処理）</h3></div>
  <div class="menu_wrapper_inner">
    <a class="menu_bt" href="{% url 'procurement:create_order' %}">発注実施</a>
    <input type="submit" value="発注報告" class="menu_bt menu_bt_mg_left row-yellow">
  </div>
</div>


<table class="item-table table_order">

	<tr>
		<th class="sticky_col_th first_col">選択</th>
		<th class="sticky_col_th second_col">発注番号</th>
    <th>発注日</th>
    <th>進捗状況</th>
    <th>発注者</th>
    <th>発注者所属</th>
    <th>発注先</th>
		<th>到着予定日</th>
		<th>税込10%</th>
		<th>税込8%</th>
		<th>非課税</th>
		<th>税込合計</th>
		<th>支払方法</th>
		<th>発注メモ</th>
		<th>予定金額</th>
		<th>納品日</th>
		<th>納品担当者</th>
		<th>納品メモ</th>
  </tr>
  
  {% for item in object_list_order %}

    <!-- 進捗状況に応じた色の設定 -->
    {% if item.progress.no == 1 %}
      <tr class="row-yellow">
    {%  elif item.progress.no == 2 %}
      <tr class="row-blue">
    {%  elif item.progress.no == 3 %}
      <tr class="row-green">
    {%  elif item.progress.no == 4 %}
    <tr class="row-gray">
    {% endif %}

      <td class="sticky_col_td first_col">
        <input type="radio" name="selected_order" id="item{{ forloop.counter }}" value="{{ item.pk }}" checked="checked" >
      </td>

      <td class="sticky_col_td second_col">
        <a href="{% url 'procurement:detail_order' item.pk %}">
          <p>{{ item.orderNum }}</p>
        </a>
      </td>
     
      <td class="date_col">{{ item.orderDate | date:"Y/m/d"}}</td>
      <td>{{ item.progress.name }}</td>
      <td>{{ item.orderStaff }}</td>
      <td>{{ item.orderStaffDivision.name }}</td>

      <td>
      {% if item.registeredSupplier %}
      {{ item.registeredSupplier.name }}
      {% else %}
        {{ item.irregularSupplier }}
      {% endif %}
      </td>

      <td>{{ item.arrivalDate | date:"Y/m/d" }}</td>

      <td class="number_col">{{ item.amount1|intcomma }}</td>
      <td class="number_col">{{ item.amount2|intcomma }}</td>
      <td class="number_col">{{ item.amount3|intcomma }}</td>
      <td class="number_col">{{ item.totalAmount|intcomma }}</td>

      <td>{{ item.payment.name }}</td>
      <td>{{ item.orderDescription }}</td>

      <td>{{ item.acceptanceDate | date:"Y/m/d" }}</td>
      <td>{{ item.acceptanceStaff }}</td>
      <td>{{ item.acceptanceStaffDivision.name }}</td>

      <td class="longText">{{ item.acceptanceMemo }}</td>
  </tr>

  {% endfor %}
  
</table>
</form>

<script>
  
$(function() {
  $('input[type="tel"]')
    .focusin(function() {
    })
    .focusout(function(){

      let h = $(this).val().replace(/[^0-9]/g, '');   // 入力値から数字（0～9）以外の文字を削除
      
      let i = h.replace(/(\d)(?=(\d\d\d)+(?!\d))/g, '$1,'); // カンマ区切りの3桁に変換する
      
      $(this).val(i);  // テキストボックス内の値を上書き
    });
});

let request_amount = document.getElementById('request_amount');
let order_amount = document.getElementById('order_amount');
let diff_amount = document.getElementById('diff_amount');

// 発注依頼合計の入力（選択）で自動計算
request_amount.addEventListener('change', function() {
  let str1 = $(this).val();
  let num1 = Number(str1.replace(/[^0-9]/g, ''));
  console.log(num1)

  let str2 = order_amount.value;
  let num2 = Number(str2.replace(/[^0-9]/g, ''));
  console.log(num2)

	let diff = num1 - num2;
  diff_amount.value = diff;

  let h = document.getElementById('diff_amount').value.replace(/[^0-9]/g, '');   // 入力値から数字（0～9）以外の文字を削除
  let i = h.replace(/(\d)(?=(\d\d\d)+(?!\d))/g, '$1,'); // カンマ区切りの3桁に変換する 
  document.getElementById('diff_amount').value = i;  // テキストボックス内の値を上書き

});

// 発注金額の入力（選択）で自動計算
order_amount.addEventListener('change', function() {
  let str1 = $(this).val();
  let num1 = Number(str1.replace(/[^0-9]/g, ''));
  console.log(num1)

  let str2 = request_amount.value;
  let num2 = Number(str2.replace(/[^0-9]/g, ''));
  console.log(num2)

	let diff = num1 - num2;
  diff_amount.value = diff;

  let h = document.getElementById('diff_amount').value.replace(/[^0-9]/g, '');   // 入力値から数字（0～9）以外の文字を削除
  let i = h.replace(/(\d)(?=(\d\d\d)+(?!\d))/g, '$1,'); // カンマ区切りの3桁に変換する 
  document.getElementById('diff_amount').value = i;  // テキストボックス内の値を上書き
});


function set_pk_order(){
  //selected_orderのpkを確認
  let list_order = document.getElementsByName('selected_order');
  let len = list_order.length;
  let selected_order = '';

  for (let i = 0; i < len ; i++){
    if (list_order[i].checked){
      selected_order = list_order[i].value;
    }
  }
}
window.onload = set_pk_order();

</script>

{% endblock content%}


